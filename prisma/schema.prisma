generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  ADMIN
  HOST
  CLIENT
  MODERATOR
  SUPPORT
  FINANCE
}

enum ListingType {
  HOTEL
  APARTMENT
}

enum ReservationStatus {
  PENDING_PAYMENT
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELED
  REFUNDED
  DISPUTED
}

enum CancelPolicy {
  FLEXIBLE
  MODERATE
  STRICT
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TicketStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentStatus {
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  REFUNDED
}

enum ThreadType {
  RESERVATION
  SUPPORT
}

enum ThreadStatus {
  INQUIRY
  PREAPPROVED
  OFFER
  REJECTED
  RESERVATION
}

model User {
  id            String      @id @default(cuid())
  email         String      @unique
  passwordHash  String
  emailVerified DateTime?
  stripeAccountId String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  profile       Profile?
  roles         UserRole[]
  listings      Listing[]   @relation("HostListings")
  reservations  Reservation[]
  messages      Message[]   @relation("MessageSender")
  createdThreads MessageThread[] @relation("ThreadCreator")
  threadParticipants MessageThreadParticipant[]
  tickets       Ticket[]    @relation("TicketCreator")
  ticketMessages TicketMessage[]
  kycSubmissions KycSubmission[]
  reviews       Review[]    @relation("ReviewAuthor")
  payments      Payment[]
  payouts       Payout[]
  auditLogs     AuditLog[]  @relation("AuditActor")
}

model Profile {
  id        String   @id @default(cuid())
  userId    String   @unique
  name      String
  phone     String?
  avatarUrl String?
  locale    String   @default("es-AR")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
}

model Role {
  id          String           @id @default(cuid())
  name        RoleName         @unique
  description String?
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String

  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Listing {
  id            String          @id @default(cuid())
  hostId        String
  title         String
  description   String
  type          ListingType
  address       String
  city          String
  neighborhood  String
  latitude      Float?
  longitude     Float?
  pricePerNight Decimal         @db.Decimal(10,2)
  netoDeseadoUsd Decimal?       @db.Decimal(10,2)
  precioClienteCalculadoUsd Decimal? @db.Decimal(10,2)
  cleaningFee   Decimal         @db.Decimal(10,2)
  serviceFee    Decimal         @db.Decimal(10,2)
  taxRate       Decimal         @db.Decimal(5,2)
  capacity      Int
  beds          Int
  baths         Int
  instantBook   Boolean         @default(true)
  cancelPolicy  CancelPolicy    @default(MODERATE)
  status        String          @default("ACTIVE")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  host          User            @relation("HostListings", fields: [hostId], references: [id])
  photos        ListingPhoto[]
  amenities     ListingAmenity[]
  calendarBlocks CalendarBlock[]
  roomTypes     RoomType[]
  reservations  Reservation[]
  reviews       Review[]
}

model ListingPhoto {
  id        String   @id @default(cuid())
  listingId String
  url       String
  sortOrder Int      @default(0)

  listing   Listing  @relation(fields: [listingId], references: [id])
}

model Amenity {
  id    String @id @default(cuid())
  name  String @unique
  icon  String?

  listings ListingAmenity[]
}

model ListingAmenity {
  listingId String
  amenityId String

  listing   Listing @relation(fields: [listingId], references: [id])
  amenity   Amenity @relation(fields: [amenityId], references: [id])

  @@id([listingId, amenityId])
}

model CalendarBlock {
  id        String   @id @default(cuid())
  listingId String
  startDate DateTime
  endDate   DateTime
  reason    String?
  createdBy String
  createdAt DateTime @default(now())

  listing   Listing @relation(fields: [listingId], references: [id])
}

model RoomType {
  id        String   @id @default(cuid())
  listingId String
  name      String
  quantity  Int      @default(1)
  priceModifier Decimal @db.Decimal(10,2) @default(0)

  listing   Listing @relation(fields: [listingId], references: [id])
  reservations Reservation[]
}

model Reservation {
  id            String            @id @default(cuid())
  listingId     String
  userId        String
  roomTypeId    String?
  status        ReservationStatus @default(PENDING_PAYMENT)
  checkIn       DateTime
  checkOut      DateTime
  guestsCount   Int
  total         Decimal           @db.Decimal(10,2)
  currency      String            @default("USD")
  holdExpiresAt DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  listing       Listing           @relation(fields: [listingId], references: [id])
  user          User              @relation(fields: [userId], references: [id])
  roomType      RoomType?         @relation(fields: [roomTypeId], references: [id])
  guests        ReservationGuest[]
  payment       Payment?
  thread        MessageThread?
  review        Review?
}

model ReservationGuest {
  id             String      @id @default(cuid())
  reservationId  String
  name           String
  age            Int?

  reservation    Reservation @relation(fields: [reservationId], references: [id])
}

model Payment {
  id                    String        @id @default(cuid())
  reservationId         String        @unique
  userId                String
  stripePaymentIntentId String?
  stripeSessionId       String?
  amount                Decimal       @db.Decimal(10,2)
  currency              String        @default("USD")
  status                PaymentStatus @default(REQUIRES_ACTION)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  reservation           Reservation   @relation(fields: [reservationId], references: [id])
  user                  User          @relation(fields: [userId], references: [id])
}

model Payout {
  id              String   @id @default(cuid())
  hostId          String
  reservationId   String
  amount          Decimal  @db.Decimal(10,2)
  currency        String   @default("USD")
  status          String   @default("PENDING")
  stripeTransferId String?
  createdAt       DateTime @default(now())

  host            User     @relation(fields: [hostId], references: [id])
}

model MessageThread {
  id           String               @id @default(cuid())
  type         ThreadType           @default(RESERVATION)
  status       ThreadStatus         @default(INQUIRY)
  reservationId String?            @unique
  offerTotal   Decimal?             @db.Decimal(10,2)
  offerCurrency String?             @default("USD")
  offerExpiresAt DateTime?
  subject      String?
  createdById  String
  createdAt    DateTime             @default(now())

  reservation  Reservation?         @relation(fields: [reservationId], references: [id])
  createdBy    User                 @relation("ThreadCreator", fields: [createdById], references: [id])
  participants MessageThreadParticipant[]
  messages     Message[]
}

model MessageThreadParticipant {
  threadId String
  userId   String

  thread   MessageThread @relation(fields: [threadId], references: [id])
  user     User          @relation(fields: [userId], references: [id])

  @@id([threadId, userId])
}

model Message {
  id            String        @id @default(cuid())
  threadId      String
  senderId      String
  body          String
  attachmentUrl String?
  createdAt     DateTime      @default(now())
  seenAt        DateTime?

  thread        MessageThread @relation(fields: [threadId], references: [id])
  sender        User          @relation("MessageSender", fields: [senderId], references: [id])
}

model Ticket {
  id           String         @id @default(cuid())
  createdById  String
  assigneeId   String?
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  subject      String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  createdBy    User           @relation("TicketCreator", fields: [createdById], references: [id])
  messages     TicketMessage[]
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  senderId  String
  body      String
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])
}

model KycSubmission {
  id          String    @id @default(cuid())
  userId      String
  status      KycStatus @default(PENDING)
  docFrontUrl String
  docBackUrl  String?
  selfieUrl   String?
  notes       String?
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id])
}

model Review {
  id            String      @id @default(cuid())
  reservationId String      @unique
  reviewerId    String
  listingId     String
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now())

  reservation   Reservation @relation(fields: [reservationId], references: [id])
  reviewer      User        @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  listing       Listing     @relation(fields: [listingId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String
  meta      Json?
  createdAt DateTime @default(now())

  actor     User     @relation("AuditActor", fields: [actorId], references: [id])
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model LegalPage {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String
  published Boolean  @default(true)
  updatedAt DateTime @updatedAt
}
